{"version":3,"sources":["../src/util.js"],"names":["api","pagination","aggregatePagination","aggregate","parseContent","fetchOptions","method","mode","credentials","Object","assign","format","action","redirects","params","keys","qs","forEach","key","apiOptions","origin","apiUrl","querystring","stringify","headers","url","then","res","ok","json","Error","status","statusText","error","info","results","parseResults","query","srsearch","filter","continueType","continueKey","resolution","next","previousResults","pageLimit","list","prefix","map","e","continue","continueWith","nextFromKey","nextResults","headingPattern","getHeadings","exec","text","matches","push","level","match","trim","length","start","index","end","source","Math","min","headings","substring","heading","title","minLevel","id","content","items","lastParentLevel","sections","i","section","parent","findSection","find","s","root"],"mappings":"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","file":"util.js","sourcesContent":["import fetch from 'cross-fetch';\nimport querystring from 'querystring';\n\nconst fetchOptions = {\n\tmethod: 'GET',\n\tmode: 'cors',\n\tcredentials: 'omit'\n};\n\nexport function api(apiOptions, params = {}) {\n\tconst qs = Object.assign(\n\t\t{\n\t\t\tformat: 'json',\n\t\t\taction: 'query',\n\t\t\tredirects: '1'\n\t\t},\n\t\tparams\n\t);\n\t// Remove undefined properties\n\tObject.keys(qs).forEach(key => {\n\t\tif (qs[key] === undefined) {\n\t\t\tdelete qs[key];\n\t\t}\n\t});\n\tif (apiOptions.origin) {\n\t\tqs.origin = apiOptions.origin;\n\t}\n\tconst url = `${apiOptions.apiUrl}?${querystring.stringify(qs)}`;\n\tconst headers = Object.assign(\n\t\t{ 'User-Agent': 'WikiJS Bot v1.0' },\n\t\tapiOptions.headers\n\t);\n\treturn fetch(url, Object.assign({ headers }, fetchOptions))\n\t\t.then(res => {\n\t\t\tif (res.ok) {\n\t\t\t\treturn res.json();\n\t\t\t}\n\t\t\tthrow new Error(`${res.status}: ${res.statusText}`);\n\t\t})\n\t\t.then(res => {\n\t\t\tif (res.error) {\n\t\t\t\tthrow new Error(res.error.info);\n\t\t\t}\n\t\t\treturn res;\n\t\t});\n}\n\nexport function pagination(apiOptions, params, parseResults) {\n\treturn api(apiOptions, params).then(res => {\n\t\tlet resolution = {};\n\t\tresolution.results = parseResults(res);\n\t\tresolution.query = params.srsearch;\n\t\tif (res['continue']) {\n\t\t\tconst continueType = Object.keys(res['continue']).filter(\n\t\t\t\tkey => key !== 'continue'\n\t\t\t)[0];\n\t\t\tconst continueKey = res['continue'][continueType];\n\t\t\tparams[continueType] = continueKey;\n\t\t\tresolution.next = () => pagination(apiOptions, params, parseResults);\n\t\t}\n\t\treturn resolution;\n\t});\n}\n\nexport function aggregatePagination(pagination, previousResults = []) {\n\treturn pagination.then(res => {\n\t\tconst results = [...previousResults, ...res.results];\n\t\tif (res.next) {\n\t\t\treturn aggregatePagination(res.next(), results);\n\t\t} else {\n\t\t\treturn results;\n\t\t}\n\t});\n}\n\nconst pageLimit = 500;\n\nexport function aggregate(apiOptions, params, list, key, prefix, results = []) {\n\tparams.list = list;\n\tparams[prefix + 'limit'] = pageLimit;\n\treturn api(apiOptions, params).then(res => {\n\t\tconst nextResults = [...results, ...res.query[list].map(e => e[key])];\n\t\tconst continueWith = res['query-continue'] || res.continue;\n\t\tif (continueWith) {\n\t\t\tconst nextFromKey =\n\t\t\t\t(continueWith[list] && continueWith[list][prefix + 'from']) ||\n\t\t\t\t(continueWith[list] && continueWith[list][prefix + 'continue']) ||\n\t\t\t\tcontinueWith[prefix + 'continue'];\n\t\t\tparams[prefix + 'continue'] = nextFromKey;\n\t\t\tparams[prefix + 'from'] = nextFromKey;\n\t\t\treturn aggregate(apiOptions, params, list, key, prefix, nextResults);\n\t\t}\n\t\treturn nextResults;\n\t});\n}\n\nconst headingPattern = /(==+)(?:(?!\\n)\\s?)((?:(?!==|\\n)[^])+)(?:(?!\\n)\\s?)(==+)/g;\n\nfunction getHeadings(text) {\n\tlet match;\n\tconst matches = [];\n\twhile ((match = headingPattern.exec(text)) !== null) {\n\t\tmatches.push({\n\t\t\tlevel: match[1].trim().length,\n\t\t\ttext: match[2].trim(),\n\t\t\tstart: match.index,\n\t\t\tend: match.index + match[0].length\n\t\t});\n\t}\n\treturn matches;\n}\n\nexport function parseContent(source) {\n\tconst headings = getHeadings(source);\n\n\tconst minLevel = Math.min(...headings.map(({ level }) => level));\n\n\tconst sections = headings.map((heading, index) => {\n\t\tconst next = headings[index + 1];\n\t\tconst content = source\n\t\t\t.substring(heading.end, next ? next.start : undefined)\n\t\t\t.trim();\n\t\treturn {\n\t\t\ttitle: heading.text,\n\t\t\tlevel: heading.level - minLevel,\n\t\t\tid: index,\n\t\t\tcontent,\n\t\t\titems: []\n\t\t};\n\t});\n\n\tconst lastParentLevel = (index, level) => {\n\t\tif (level === 0) return null;\n\t\tfor (let i = index - 1; i >= 0; i--) {\n\t\t\tif (sections[i].level < level) {\n\t\t\t\treturn sections[i].id;\n\t\t\t}\n\t\t}\n\t\treturn null;\n\t};\n\n\t// Set parents\n\tsections.forEach((section, index) => {\n\t\tsection.parent = lastParentLevel(index, section.level);\n\t});\n\n\tconst root = {\n\t\titems: []\n\t};\n\n\tconst findSection = id => sections.find(s => id === s.id);\n\n\t// Organize\n\tsections.forEach(section => {\n\t\tif (section.parent === null) {\n\t\t\troot.items.push(section);\n\t\t} else {\n\t\t\tfindSection(section.parent).items.push(section);\n\t\t}\n\t});\n\n\t// Clean up\n\tsections.forEach(section => {\n\t\tdelete section.id;\n\t\tdelete section.parent;\n\t\tdelete section.level;\n\t\tif (!section.items.length) {\n\t\t\tdelete section.items;\n\t\t}\n\t});\n\n\treturn root.items;\n}\n"]}