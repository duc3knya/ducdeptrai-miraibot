'use strict';Object.defineProperty(exports,'__esModule',{value:!0});var _slicedToArray=function(){function c(d,e){var f=[],g=!0,h=!1,j=void 0;try{for(var l,k=d[Symbol.iterator]();!(g=(l=k.next()).done)&&(f.push(l.value),!(e&&f.length===e));g=!0);}catch(m){h=!0,j=m}finally{try{!g&&k['return']&&k['return']()}finally{if(h)throw j}}return f}return function(d,e){if(Array.isArray(d))return d;if(Symbol.iterator in Object(d))return c(d,e);throw new TypeError('Invalid attempt to destructure non-iterable instance')}}(),_typeof='function'==typeof Symbol&&'symbol'==typeof Symbol.iterator?function(c){return typeof c}:function(c){return c&&'function'==typeof Symbol&&c.constructor===Symbol&&c!==Symbol.prototype?'symbol':typeof c};exports.default=wikiPage;var _util=require('./util'),_infoboxParser=require('infobox-parser'),_infoboxParser2=_interopRequireDefault(_infoboxParser),_hyntax=require('hyntax'),_coordinates=require('./coordinates'),_chain=require('./chain'),_chain2=_interopRequireDefault(_chain);function _interopRequireDefault(c){return c&&c.__esModule?c:{default:c}}function _toConsumableArray(c){if(Array.isArray(c)){for(var d=0,e=Array(c.length);d<c.length;d++)e[d]=c[d];return e}return Array.from(c)}var get=function(c,d){for(var e=arguments.length,f=Array(2<e?e-2:0),g=2;g<e;g++)f[g-2]=arguments[g];return void 0===c||void 0===d?c:'function'==typeof d?get.apply(void 0,[d(c)].concat(f)):get.apply(void 0,[c[d]].concat(f))},firstValue=function(c){return'object'===('undefined'==typeof c?'undefined':_typeof(c))?c[Object.keys(c)[0]]:c[0]},getFileName=function(c){if(Array.isArray(c)&&(c=c[0]),!!c){if(-1!==c.indexOf(':')){var d=c.split(':'),e=_slicedToArray(d,2),f=e[1];return f}return c}};function wikiPage(c,d){function e(){return(0,_util.api)(d,{prop:'revisions',rvprop:'content',rvlimit:1,rvparse:'',titles:F.title}).then(function(H){return H.query.pages[F.pageid].revisions[0]['*']})}function f(){return g().then(_util.parseContent)}function g(){return E().content().request().then(function(H){return H.extract})}function j(){return E().image({original:!0,name:!0}).request().then(function(H){return get(H,'image','original','source')})}function k(){return(0,_util.api)(d,{generator:'images',gimlimit:'max',prop:'imageinfo',iiprop:'url',titles:F.title}).then(function(H){return H.query?Object.keys(H.query.pages).map(function(I){return H.query.pages[I]}):[]})}function o(H,I){return H.content.attributes&&H.content.attributes.some(function(J){return'class'===J.key.content&&-1!==J.value.content.indexOf(I)})}function p(H){return'tag'===H.nodeType}function q(H,I){return H.content.name===I}function r(H,I){if(I(H))return H;if(H.content.children){var J=!0,K=!1,L=void 0;try{for(var N,M=H.content.children[Symbol.iterator]();!(J=(N=M.next()).done);J=!0){var O=N.value,P=r(O,I);if(P)return P}}catch(O){K=!0,L=O}finally{try{!J&&M.return&&M.return()}finally{if(K)throw L}}}return null}function s(H,I,J){if(I(H)&&J.push(H),H.content.children){var K=!0,L=!1,M=void 0;try{for(var O,P,N=H.content.children[Symbol.iterator]();!(K=(O=N.next()).done);K=!0)P=O.value,s(P,I,J)}catch(P){L=!0,M=P}finally{try{!K&&N.return&&N.return()}finally{if(L)throw M}}}}function x(H){return(0,_util.api)(d,{prop:'revisions',rvprop:'content',rvsection:0,titles:H||F.title}).then(function(I){return get(I,'query','pages',firstValue,'revisions',0,'*')})}function z(H){return x().then(function(I){var J=(0,_infoboxParser2.default)(I,d.parser).general;return 0===Object.keys(J).length?x('Template:Infobox '+F.title.toLowerCase()).then(function(K){return(0,_infoboxParser2.default)(K||'',d.parser).general}):J}).then(function(I){return H?I.hasOwnProperty(H)?I[H]:void 0:I})}function E(){return new _chain2.default(d,F.pageid)}var F=c,G=Object.assign({},F);return Object.assign(G,{raw:F,html:e,rawContent:g,content:f,sections:f,summary:function(){return E().summary().request().then(function(H){return H.extract})},images:function(){return k().then(function(H){return H.map(function(I){return I.imageinfo}).reduce(function(I,J){return[].concat(_toConsumableArray(I),_toConsumableArray(J))},[]).map(function(I){return I.url})})},references:function(){return e().then(function(H){var I=(0,_hyntax.tokenize)(H),J=I.tokens,K=(0,_hyntax.constructTree)(J),L=K.ast;return L}).then(function(H){var I=[],J=[];s(H,function(Z){return p(Z)&&q(Z,'ol')&&o(Z,'references')},J);var K=!0,L=!1,M=void 0;try{for(var O,N=J[Symbol.iterator]();!(K=(O=N.next()).done);K=!0){var Z=O.value,$=Z.content.children.filter(function(_){return p(_)&&q(_,'li')&&_.content.children}),P=!0,Q=!1,R=void 0;try{for(var T,S=$[Symbol.iterator]();!(P=(T=S.next()).done);P=!0){var _=T.value,aa=_.content.children[2],ba=r(aa,function(ca){return p(ca)&&q(ca,'cite')});if(ba){var U=!0,V=!1,W=void 0;try{for(var Y,ca,X=ba.content.children[Symbol.iterator]();!(U=(Y=X.next()).done);U=!0)if(ca=Y.value,p(ca)&&q(ca,'a')&&o(ca,'external')){var da=ca.content.attributes.find(function(ea){return'href'===ea.key.content});I.push(da.value.content)}}catch(ca){V=!0,W=ca}finally{try{!U&&X.return&&X.return()}finally{if(V)throw W}}}}}catch(_){Q=!0,R=_}finally{try{!P&&S.return&&S.return()}finally{if(Q)throw R}}}}catch(Z){L=!0,M=Z}finally{try{!K&&N.return&&N.return()}finally{if(L)throw M}}return I})},links:function(){var H=0<arguments.length&&void 0!==arguments[0]?arguments[0]:!0,I=1<arguments.length&&void 0!==arguments[1]?arguments[1]:100,J=(0,_util.pagination)(d,{prop:'links',plnamespace:0,pllimit:I,titles:F.title},function(K){return(K.query.pages[F.pageid].links||[]).map(function(L){return L.title})});return H?(0,_util.aggregatePagination)(J):J},externalLinks:function(){return E().direct('extlinks')},categories:function(){var H=0<arguments.length&&void 0!==arguments[0]?arguments[0]:!0,I=1<arguments.length&&void 0!==arguments[1]?arguments[1]:100,J=(0,_util.pagination)(d,E().categories(I).params(),function(K){return(K.query.pages[F.pageid].categories||[]).map(function(L){return L.title})});return H?(0,_util.aggregatePagination)(J):J},coordinates:function(){return E().direct('coordinates').then(function(H){return H?H:z().then(function(I){return(0,_coordinates.parseCoordinates)(I)})})},info:z,backlinks:function(){var H=0<arguments.length&&void 0!==arguments[0]?arguments[0]:!0,I=1<arguments.length&&void 0!==arguments[1]?arguments[1]:100,J=(0,_util.pagination)(d,{list:'backlinks',bllimit:I,bltitle:F.title},function(K){return(K.query.backlinks||[]).map(function(L){return L.title})});return H?(0,_util.aggregatePagination)(J):J},rawImages:k,mainImage:function(){return Promise.all([k(),z()]).then(function(H){var I=_slicedToArray(H,2),J=I[0],K=I[1],L=getFileName(K.image||K.bildname||K.imagen||K.Immagine||K.badge||K.logo);if(!L)return x().then(function(O){if(J.length){J.sort(function(R,S){return O.indexOf(S.title)-O.indexOf(R.title)});var P=J[0],Q=P&&0<P.imageinfo.length?P.imageinfo[0].url:void 0;return j().then(function(R){return R||Q})}});var M=J.find(function(O){var P=O.title,Q=getFileName(P);return Q.toUpperCase()===L.toUpperCase()||Q.replace(/\s/g,'_')===L}),N=M&&0<M.imageinfo.length?M.imageinfo[0].url:void 0;return j().then(function(O){return O||N})})},langlinks:function(){return E().direct('langlinks')},rawInfo:x,fullInfo:function(){return x().then(function(H){return(0,_infoboxParser2.default)(H,d.parser)})},pageImage:j,tables:function(){return(0,_util.api)(d,{prop:'revisions',rvprop:'content',titles:F.title}).then(function(H){return get(H,'query','pages',firstValue,'revisions',0,'*')}).then(function(H){return(0,_infoboxParser2.default)(H,d.parser).tables})},url:function(){return F.canonicalurl},chain:E}),G}
//# sourceMappingURL=page.js.map